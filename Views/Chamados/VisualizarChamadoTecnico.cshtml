@model HelpFast_Pim.Models.Chamado
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Visualizar Chamado - Técnico";
}

<style>
    body { background: #0f1b23; }
    /* estilo ajustado para ficar similar ao protótipo */
    .chat-page { display:flex; justify-content:center; padding:40px 0; background:transparent; }
    .chat-card {
        background:#13202a; border-radius:18px; padding:28px; width:760px; color:#fff; box-shadow:0 10px 0 rgba(0,0,0,0.4);
    }
    .header { display:flex; align-items:center; justify-content:space-between; gap:18px; margin-bottom:18px; }
    .header .logo { height:78px; }
    .header .meta { color:#fff; font-size:15px; }
    .header .meta strong { margin-right:10px; font-weight:600; }

    .chat-inner {
        background:#ffffff; color:#111; border-radius:12px; padding:18px; height:420px;
        display:flex; flex-direction:column; overflow:hidden;
    }
    .messages {
        flex:1; overflow-y:auto; padding:8px; display:flex; flex-direction:column; gap:12px;
        word-wrap:break-word; white-space:pre-wrap;
    }
    .msg {
        max-width:66%; padding:10px 12px; border-radius:10px; font-size:13px; line-height:1.2;
        position:relative;
        box-shadow: 0 1px 0 rgba(0,0,0,0.04);
        overflow-wrap:break-word;
    }
    .msg .meta-time { position:absolute; right:10px; top:6px; font-size:11px; color:#666; }
    .msg.assistant {
        background:#dcdcdc; color:#000; align-self:flex-start; border-bottom-left-radius:6px;
    }
    .msg.client {
        background:#bfc6cc; color:#000; align-self:flex-end; border-bottom-right-radius:6px;
    }

    .tech-actions {
        display:flex; gap:10px; justify-content:flex-end;
    }
    .btn-action-tech {
        display:inline-flex; align-items:center; justify-content:center;
        width:32px; height:32px; border-radius:6px; border:0;
        cursor:pointer; background:#e0e4eb; color:#333; transition:all 0.3s ease;
    }
    .btn-action-tech:hover { background:#d0dce8; }

    .back-btn { display:block; margin:18px auto 0; background:#fff; color:#000; padding:10px 28px; border-radius:8px; text-decoration:none; text-align:center; width:220px; }

    @@media (max-width:760px) {
        .chat-card { width:94%; padding:16px; }
        .header .logo { height:56px; }
        .header { flex-wrap:wrap; }
        .tech-actions { width:100%; margin-top:10px; }
    }
</style>

<div class="chat-page">
    <div class="chat-card">
        <div class="header">
            <div style="display:flex; align-items:center; gap:18px;">
                <img class="logo" src="/images/logoh.png" alt="HelpFast" />
                <div class="meta">
                    <div><strong>ID Chamado:</strong> <span>#@Model.Id</span></div>
                    <div style="margin-top:6px;"><strong>Motivo:</strong> <span>@Model.Motivo</span></div>
                </div>
            </div>
            <div class="tech-actions">
                @if (Model.Status != "Finalizado" && Model.Status != "Cancelado")
                {
                    <form method="POST" action="/Chamados/CancelarChamadoTecnico/@Model.Id" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja CANCELAR este chamado?');">
                        <button type="submit" class="btn-action-tech" title="Cancelar Chamado">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                        </button>
                    </form>
                    <form method="POST" action="/Chamados/ConcluirChamadoTecnico/@Model.Id" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja FINALIZAR este chamado?');">
                        <button type="submit" class="btn-action-tech" title="Finalizar Chamado">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </button>
                    </form>
                }
            </div>
        </div>

        <div class="chat-inner" id="chat-root">
            <div class="messages" id="messages" aria-live="polite" aria-atomic="false">
                @if (Model.Chats == null || Model.Chats.Count == 0)
                {
                    <div style="color:#999; text-align:center; padding:20px;">
                        <p>Nenhuma mensagem neste chamado.</p>
                    </div>
                }
                else
                {
                    @foreach (var chat in Model.Chats.OrderBy(c => c.DataEnvio))
                    {
                        <div class="msg @(chat.Tipo == "Usuario" ? "client" : "assistant")">
                            <div>
                                @if (chat.Tipo == "Usuario")
                                {
                                    <div><strong>Cliente</strong></div>
                                }
                                else
                                {
                                    <div><strong>@(chat.Tipo ?? "Sistema")</strong></div>
                                }
                                <div>@chat.Mensagem</div>
                                <div class="meta-time">@chat.DataEnvio.ToString("HH:mm")</div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <a class="back-btn" href="/Chamados/ConsultarChamados">Voltar ao menu</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var messagesEl = document.getElementById('messages');
        if (messagesEl) {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
    });
</script>
